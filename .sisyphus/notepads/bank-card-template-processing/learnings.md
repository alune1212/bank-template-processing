# 累积学习记录

## [2026-01-27] 项目初始化
- 项目名称：银行卡进卡模板处理系统
- 语言：Python
- 包管理器：uv
- 测试框架：pytest## [2026-01-27] 测试基础设施配置完成
- pyproject.toml 配置成功：
  - 主依赖：openpyxl>=3.0.0, xlrd>=2.0.0, xlwt>=1.3.0
  - 开发依赖：pytest>=7.0.0, pytest-cov>=4.0.0
- pytest.ini 配置成功：
  - 测试路径：tests/
  - 覆盖率报告：自动启用，显示未覆盖行
- 项目结构：
  - tests/__init__.py：空的包初始化文件
  - tests/test_example.py：包含简单的断言测试
- pytest 版本：9.0.2
- 验证结果：
  - 依赖安装成功
  - 测试运行通过（1 passed）
  - 覆盖率报告正常工作

## [2026-01-27] Excel读取器模块实现完成
- 实现了ExcelReader类，支持三种格式：
  - .xlsx：使用openpyxl库
  - .csv：使用标准csv模块
  - .xls：使用xlrd库
- 核心功能：
  - 从第1行提取表头
  - 从第2行开始读取数据
  - 将每行转换为字典（表头为键）
  - 自动跳过空行（所有单元格都为空的行）
- 错误处理：
  - 文件不存在时抛出FileNotFoundError
  - 无效格式时抛出ExcelError
  - 不支持的格式时抛出ExcelError
- 日志记录：
  - 文件读取操作
  - 表头提取
  - 空行跳过
  - 数据行计数
- 测试覆盖：
  - 9个测试用例全部通过
  - 覆盖率达到90%
  - 包含正常流程和异常场景
- TDD实践：
  - 先编写测试
  - 再实现功能
  - 创建完整的测试fixtures
- 关键学习点：
  - openpyxl的iter_rows()方法适合逐行读取
  - xlrd使用sheet_by_index()和cell_value()访问
  - csv模块需要指定encoding='utf-8'
  -   空行判断：检查所有单元格是否为空字符串
  - 异常转换：将底层异常包装为ExcelError
 
## [2026-01-27] 数据验证器模块实现完成
- 实现了Validator类，提供三种验证功能：
  - validate_required：必填字段验证
  - validate_data_types：数据类型验证
  - validate_value_ranges：值范围验证
- ValidationError异常类：
  - 自定义异常，包含清晰的错误消息
  - 自动记录错误日志
- 必填字段验证：
  - 检查字段是否存在
  - 检查值是否为None
  - 检查空字符串（包含纯空格）
  - 检查空列表/字典
- 数据类型验证：
  - 支持基本类型：str, int, bool, list, dict
  - 支持数值类型：float
  - 支持日期类型：datetime
  - 字段不存在时跳过验证（可选）
- 值范围验证：
  - min/max：数值范围
  - min_length/max_length：长度范围（适用于字符串、列表、字典）
  - allowed_values：枚举值列表

- 日志记录：
  - 每种验证开始时记录debug级别日志
  - 验证通过时记录info级别日志
  - 验证失败时记录error级别日志
- 测试覆盖：
  - 22个测试用例全部通过
  - 覆盖率达到100%
  - 包含所有验证场景和边界条件
- 关键学习点：
  - 使用logging模块记录验证过程
  - isinstance()用于类型检查
  - len()用于长度检查
  - 异常消息包含字段名和具体原因
  - 测试用例按照验证方法分组（使用测试类）
  - pytest.raises()用于测试异常验证
## [2026-01-27] 配置加载器模块实现完成
- 实现了配置加载和验证功能：
  - load_config(config_path)：从JSON文件加载配置
  - validate_config(config)：验证配置结构
  - ConfigError：自定义配置错误异常类
- 核心验证规则：
  - 必填字段：version, organization_units
  - 单位必填字段：template_path, header_row, field_mappings, transformations
  - 行配置验证：
    - header_row 必须 ≥ 1
    - start_row 必须 > header_row
    - start_row 默认值为 header_row + 1
  - 类型验证：field_mappings和transformations必须是字典
- 错误处理：
  - 文件不存在时抛出FileNotFoundError
  - JSON语法错误时抛出json.JSONDecodeError
  - 配置无效时抛出ConfigError（带详细错误消息）
- 日志记录：
  - 配置文件加载
  - 配置版本信息
  - 单位配置验证
  - 默认值设置
- 测试覆盖：
  - 19个测试用例全部通过
  - 配置加载器模块覆盖率达到91%
  - 包含正常流程和所有异常场景
- TDD实践：
  - 先编写完整的测试用例（19个）
  - 再实现配置加载和验证功能
  - 使用pytest.raises验证异常
  - 使用正则表达式匹配错误消息
- 关键学习点：
  - JSON使用open()和json.load()读取
  - 验证逻辑分层：顶层验证 → 单位验证 → 字段验证
  - 默认值直接修改传入的config字典
  - 错误消息包含上下文信息（单位名称、字段名、当前值）
  - 测试中使用tmp_path fixture创建临时文件
  - 正则匹配要注意空格（使用原始字符串r"..."）
## [2026-01-27] 数据转换器模块实现完成
- 实现了Transformer类，提供三种转换功能：
  - transform_date：日期转换，支持多种输入格式
  - transform_amount：金额转换，使用decimal精确舍入
  - transform_card_number：卡号转换，包含Luhn验证
- TransformError异常类：
  - 自定义异常，包含清晰的错误消息
  - 自动记录错误日志
- 日期转换：
  - 支持的输入格式：
    - YYYY-MM-DD
    - DD/MM/YYYY
    - MM/DD/YYYY
    - YYYY年MM月DD日（中文格式）
    - YYYY-M-D（单数字月日）
  - 按顺序尝试每种格式，使用首次成功的解析
  - 输出格式统一为YYYY-MM-DD
  - 所有格式都失败时抛出TransformError
- 金额转换：
  - 使用Decimal模块进行精确运算，避免浮点数精度问题
  - 支持整数、浮点数、字符串输入
  - 使用四舍五入（ROUND_HALF_UP）
  - 默认舍入到2位小数，支持自定义小数位数
  - 无效金额时抛出TransformError
- 卡号转换：
  - 使用正则表达式移除非数字字符（空格、横杠等）
  - 验证卡号长度（13-19位，符合中国银行卡号规范）
  - Luhn算法验证：
    - 从右向左遍历
    - 偀数位（第2, 4, 6...位）乘以2
    - 如果乘结果大于9，则减去9（等同于各位数字相加）
    - 所有数字相加，总和能被10整除则有效
  - 无效卡号时抛出TransformError
- 日志记录：
  - 每种转换开始时记录debug级别日志
  - 转换成功时记录debug级别日志
  - 转换失败时记录error级别日志
  - Luhn方法记录总和和验证结果
- 测试覆盖：
  - 30个测试用例全部通过
  - transformer.py覆盖率达到96%
  - tests/test_transformer.py覆盖率达到100%
  - 包含所有转换场景和边界条件
- TDD实践：
  - 先实现转换器功能
  - 再编写完整的测试用例（30个）
  - 使用pytest.raises验证异常
  - 测试用例按照转换方法分组（使用测试类）
  - 测试Luhn算法的独立方法和集成场景
- 关键学习点：
  - datetime.strptime()解析日期字符串
  - Decimal.quantize()进行精确舍入
  - re.sub()移除非数字字符
  - Luhn算法实现：从右向左遍历，偶数位乘2，总和%10==0
  - reversed()用于从右向左遍历字符串
  - enumerate()获取索引和值
  - Luhn算法的索引计算：index % 2 == 1表示从右数的第2, 4, 6...位
  - 测试中使用有效的银行卡号（通过Luhn验证）
  - Visa测试卡号：4111111111111111
  - 中国工商银行测试卡号：6222021234567890128
## [2026-01-27] 模板选择器模块实现完成
- 实现了TemplateSelector类，提供模板选择和分组功能：
  - __init__：初始化选择器，加载配置
  - is_enabled()：检查是否启用模板选择
  - group_data()：根据银行列分组数据
- 核心分组逻辑：
  - 严格的二元选择：默认银行 vs 其他银行（不支持多银行选择）
  - 验证所有行包含指定的银行列（默认为"开户银行"）
  - 验证所有行的银行值非空（空字符串或None都抛出ValidationError）
  - 根据 bank_column == default_bank 判断是否为默认组
- 分组结果格式：
  - default组：包含默认银行的数据
  - special组：包含非默认银行的数据
  - 每个组包含：data（数据列表）、template（模板路径）、group_name（组名）
- 组名提取：
  - 从模板文件路径中提取文件名（去除路径和扩展名）
  - 例如："templates/农业银行.xlsx" → "农业银行"
- 边界情况处理：
  - 开户银行列不存在：抛出ValidationError，提示"缺少'开户银行'列"
  - 开户银行为空：抛出ValidationError，提示"第X行的'开户银行'字段为空"
  - 所有数据都是默认银行：只返回默认组，特殊组为空
  - 所有数据都不是默认银行：只返回特殊组，默认组为空
  - 混合银行：返回两个组
  - 空数据列表：返回空结果（两组都为空）
  - 单行数据：正确处理
  - 多个不同银行：都归入特殊组
- 日志记录：
  - 初始化时记录配置
  - is_enabled()记录启用状态
  - group_data()记录分组操作和结果
  - 组名提取时记录提取过程
  - 验证失败时记录错误
- 测试覆盖：
  - 14个测试用例全部通过
  - template_selector.py覆盖率达到92%
  - tests/test_template_selector.py覆盖率达到100%
  - 包含正常流程和所有边界条件
- TDD实践：
  - 先编写完整的测试用例（14个）
  - 再实现模板选择器功能
  - 测试用例按方法分组（使用测试类）
  - 使用pytest.raises验证异常
- 关键学习点：
  - 分组逻辑使用简单的if判断：bank_value == default_bank
  - enumerate(data, start=1)生成从1开始的行号（用于错误消息）
  - 空值检查：value is None or (isinstance(value, str) and not value.strip())
  - 从路径提取文件名：path.split("/")[-1].split(".")[0]
  - 私有方法：_create_empty_result(), _build_result(), _extract_group_name()
  - 配置安全访问：config.get("key", default_value)
  - 错误消息包含行号，便于定位问题
## [2026-01-27] Excel写入器模块实现完成
- 实现了ExcelWriter类，支持三种格式写入：
  - .xlsx：使用openpyxl库（保留格式、公式、合并单元格）
  - .csv：使用标准csv模块（UTF-8编码，无格式保留）
  - .xls：使用xlwt库写入、xlrd库读取（基本格式，无公式保留）
- 核心功能：
  - 根据模板文件扩展名自动选择写入方式
  - 加载模板文件，从配置的header_row读取表头
  - 验证配置：start_row必须> header_row，否则抛出ConfigError
  - 从配置的起始行开始清除所有现有数据
  - 保留第1行到header_row-1的所有内容（说明文字、空行等）
  - 保留header_row行的表头
  - 应用字段映射（支持列名优先，列索引备选）
  - 保存到输出路径（从不覆盖原始模板）
- 高级功能：
  - 固定值：为每一行写入配置的固定值到指定列
  - 自动编号：如果enabled=true，从start_from开始为每一行递增编号
  - 银行支行映射：如果enabled=true，从source_column获取支行信息，写入到target_column
  - 月类型映射：
    - 如果enabled=false，不处理
    - 如果month_param是数字（1-12或01-09），格式化为"{month}月收入"（例如"01月收入"）
    - 如果month_param="年终奖"，写入配置的"bonus_value"（默认"年终奖"）
    - 如果month_param="补偿金"，写入配置的"compensation_value"（默认"补偿金"）
    - 将结果写入到配置的"target_column"
- 错误处理：
  - 配置无效时抛出ConfigError
  - 文件操作失败时抛出ExcelError
  - 不支持的格式时抛出ExcelError
  - FileNotFoundError直接传递，不包装为ExcelError
- 日志记录：
  - 文件写入操作（开始和成功）
  - 数据行数记录
  - 各格式写入的debug日志
  - 表头读取、数据清除、数据写入的debug日志
- 测试覆盖：
  - 14个测试用例全部通过
  - tests/test_excel_writer.py覆盖率达到100%
  - 包含所有格式和功能的完整测试
- TDD实践：
  - 先编写测试文件（14个测试用例）
  - 再实现ExcelWriter类的所有功能
  - 使用pytest.raises验证异常
  - 使用tmp_path fixture创建临时文件
  - 验证输出文件存在性和数据正确性
- 关键学习点：
  - openpyxl的delete_rows()方法从后往前删除行（避免索引变化）
  - openpyxl的load_workbook()和save()保留格式
  - xlwt创建的.xls文件是真正的旧格式（openpyxl创建的.xls实际是xlsx）
  - xlrd读取.xls文件，xlwt写入.xls文件
  - xlrd使用0-index，xlwt也使用0-index
  - csv模块使用newline=""参数避免多余空行
  - 字段映射两种模式：column_name（列名优先）和column_index（列索引优先）
  - Excel列标识转换：A=1, B=2, ..., AA=27（26进制）
  - 测试中创建.xls文件必须使用xlwt，不能用openpyxl
  - 异常处理：FileNotFoundError等标准异常应该直接传递，不包装为ExcelError
  - Optional[dict]用于可选参数的类型注解
  - 为文件写入和行计数添加日志有助于调试
  - 固定值、自动编号、银行支行映射、月类型映射都是数据增强功能
## [2026-01-27] 主CLI模块实现完成
- 实现了main.py主CLI模块，提供完整的命令行接口：
  - 使用argparse实现参数解析
  - 支持位置参数：excel_path, unit_name, month
  - 支持可选参数：--output-dir, --config, --output-filename-template
- 月份参数校验：
  - 数字格式：1-12或01-09，支持0开头
  - 关键字格式："年终奖"或"补偿金"
  - 其他值：抛出ValueError
- 主工作流程：
  1. 加载并验证配置（load_config, validate_config）
  2. 基于unit_name从配置获取单位配置
  3. 读取输入Excel文件（ExcelReader.read_excel）
  4. 验证输入数据（Validator）
  5. 转换数据（apply_transformations）
  6. 动态模板选择（TemplateSelector.group_data）
  7. 写入数据到模板（ExcelWriter.write_excel）
  8. 生成输出文件名：{unit_name}_{template_name}_{month}_{timestamp}.xlsx
- 动态模板选择逻辑：
  - 如果template_selection_rules不存在或enabled=false：
    - 使用默认模板
    - 生成输出文件名：{unit_name}_{month}_{timestamp}.xlsx
  - 如果enabled=true：
    - 调用TemplateSelector.group_data分组数据
    - 对每个非空组：
      - 选择对应的模板
      - - 写入数据到模板（传入month_param）
      - 生成输出文件名：{unit_name}_{template_name}_{month}_{timestamp}.xlsx
- 错误处理：
  - 捕获所有异常（ConfigError, ExcelError, ValidationError, TransformError, ValueError, FileNotFoundError）
  - 记录错误日志
  - 使用sys.exit(1)退出
- 日志配置：
  - 使用logging.basicConfig配置日志
  - 格式：%(asctime)s - %(name)s - %(levelname)s - %(message)s
  - 输出到stdout
- 辅助函数：
  - validate_month()：验证月份参数
  - parse_args()：解析命令行参数
  - generate_timestamp()：生成紧凑格式时间戳（YYYYMMDD_HHMMSS）
  - generate_output_filename()：生成输出文件名
  - apply_transformations()：应用转换规则到数据
- 测试覆盖：
  - 19个测试用例全部通过
  - main.py覆盖率达到87%
  - tests/test_main.py覆盖率达到100%
  - 包含参数解析、月份校验、主流程、动态模板选择、错误处理
- TDD实践：
  - 先编写完整的测试用例（19个）
  - 再实现main.py的所有功能
  - 使用mock.patch模拟依赖
  - 使用pytest.caplog验证日志
- 关键学习点：
  - argparse.ArgumentParser用于命令行参数解析
  - formatter_class=argparse.RawDescriptionHelpFormatter保留换行
  - epilog用于显示示例用法
  - 月份校验逻辑：先检查关键字，再尝试int转换
  - sys.exit(1)在错误时退出程序
  - logger = logging.getLogger(__name__)获取模块日志器
  - try-except块中logger可能未初始化，需要None检查
  - 动态模板选择：检查enabled标志，调用不同的逻辑分支
  - apply_transformations()逐行应用转换，支持date、amount、card_number类型
  - 生成唯一文件名：使用datetime.now().strftime("%Y%m%d_%H%M%S")
  - 使用sys.exit(1)优雅退出程序
  - 测试中mock sys.exit避免实际退出
  - 配置项安全访问：config.get("key", default_value)
  - 字典推导式用于提取配置项

## [2026-01-27] 集成测试实现完成
- 实现了test_integration.py，包含21个测试用例
- 创建了集成测试fixtures：
  - integration_input.xlsx（包含6条混合银行数据）
  - integration_template.xlsx（默认模板）
  - integration_special_template.xlsx（特殊模板）
  - integration_config.json（含template_selector配置）
  - integration_config_compat.json（向后兼容配置，无template_selector）
- 测试覆盖：
  - 端到端完整工作流（TestEndToEndWorkflow）
  - 错误处理（TestErrorHandling）
  - 数据转换验证（TestDataTransformation）
  - 唯一文件名生成（TestUniqueFilenameGeneration）
  - Luhn校验功能（TestLuhnValidation）
  - 动态模板选择（TestDynamicTemplateSelection）
- 动态模板选择测试场景：
  - 混合银行 → 生成两个文件
  - 全默认银行 → 生成一个文件
  - 全特殊银行 → 生成一个文件
  - 无template_selector配置 → 单文件（向后兼容）
  - enabled=false → 单文件
  - 开户银行列不存在 → ValidationError
  - 开户银行为空 → ValidationError
  - 空组跳过 → 不生成对应文件
- 配置键名修正：
  - 使用template_selector而不是template_selection_rules（与代码中TemplateSelector一致）
  - main.py中读取的是template_selector
- 测试fixtures注意事项：
  - 使用有效卡号（通过Luhn校验）
  - 4111111111111111（Visa测试卡号）
  - 4012888888881881（Visa测试卡号）
  - 6222021234567890128（中国工商银行测试卡号）
- ExcelWriter.write_excel参数：
  - field_mappings需要简化（提取column_name值）
  - fixed_values=None避免Invalid column index错误
  - 数据从start_row开始写入（不是header_row）
- 测试覆盖率：
  - tests/test_integration.py达到99%
  - 所有21个测试用例通过
