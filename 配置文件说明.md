# 配置文件说明

本文档详细说明了银行卡进卡模板处理系统的配置文件格式和各个字段的含义。系统支持灵活的配置结构，能够满足单模板和多模板（基于银行动态选择）的处理需求。

## 1. 配置文件概览

*   **格式**: JSON
*   **默认文件名**: `config.json`
*   **顶层结构**:
    *   `version`: 版本号（如 `"1.0"`）
    *   `organization_units`: 组织单位配置集合

```json
{
  "version": "1.0",
  "organization_units": {
    "单位名称A": { ... },
    "单位名称B": { ... }
  }
}
```

## 2. 单位配置结构

每个组织单位的配置支持**多规则组**结构。这意味着你可以为同一个单位配置多套处理规则（例如：一套默认规则，一套跨行规则），并通过 `template_selector` 自动选择使用哪一套。

### 核心结构

```json
"单位名称": {
  // 1. 动态模板选择器配置（可选）
  "template_selector": {
    "enabled": false,               // 是否启用动态选择
    "default_bank": "中国农业银行",   // 默认银行名称
    "special_template": "...",      // 特殊模板路径（对应非默认银行）
    "bank_column": "开户银行"        // 输入Excel中用于判断银行的列名
  },

  // 2. 默认规则组（必须包含）
  "default": {
    "template_path": "templates/default.xlsx", // 模板文件路径
    "header_row": 1,                          // 表头所在行号（从1开始）
    "field_mappings": { ... },                // 字段映射
    "transformations": { ... }                // 数据转换配置
    // ... 其他配置项
  },

  // 3. 其他规则组（可选，如 "crossbank"）
  "crossbank": {
    "template_path": "templates/special.xlsx",
    // ... 该规则组独立的配置
    "field_mappings": { ... }
  }
}
```

> **注意**: 如果 `template_selector.enabled` 为 `false`，系统将始终使用 `default` 规则组进行处理。

## 3. 详细配置项说明

以下配置项适用于每个规则组（如 `default` 或 `crossbank`）。

### 3.1 基础配置 (必填)

*   **`template_path`**: (String) 模板文件的路径（相对或绝对）。
*   **`header_row`**: (Integer) 模板中表头所在的行号（从 1 开始）。
*   **`start_row`**: (Integer, 可选) 数据开始写入的行号。默认为 `header_row + 1`。

### 3.2 字段映射 (`field_mappings`)

定义如何将输入数据映射到模板列。

```json
"field_mappings": {
  "字段标识": {
    "source_column": "姓名",       // 输入Excel中的列名
    "target_column": "B",         // 模板中的列（支持 列名 或 "A", "B" 字母索引）
    "transform": "none",          // 转换方式
    "required": true              // 是否必填
  }
}
```

**支持的 `transform` 类型**:
*   `"none"`: 直接复制，不转换。
*   `"date_format"`: 日期格式化（需配合 `transformations` 配置）。
*   `"amount_decimal"`: 金额数值转换（需配合 `transformations` 配置）。
*   `"card_number"`: 银行卡号处理（去空格、Luhn校验）。

### 3.3 转换参数 (`transformations`)

定义具体的转换规则参数。

```json
"transformations": {
  "date_format": {
    "output_format": "YYYY-MM-DD"    // 目前仅支持 YYYY-MM-DD
  },
  "amount_decimal": {
    "decimal_places": 2,             // 保留小数位数
    "rounding": "round"              // 舍入方式
  },
  "card_number": {
    "remove_formatting": true,       // 是否移除空格、横杠等非数字字符
    "luhn_validation": true          // 是否启用 Luhn 算法校验卡号合法性
  }
}
```

### 3.4 高级功能 (可选)

#### 行过滤器 (`row_filter`)
用于在读取输入文件时排除包含特定关键字的行（如合计行）。
```json
"row_filter": {
  "exclude_keywords": ["合计", "总计", "小计", "Total"]
}
```

#### 固定值 (`fixed_values`)
在模板的指定列填充固定内容。
```json
"fixed_values": {
  "省份": "浙江省",
  "业务类型": "工资代发"
}
```

#### 自动编号 (`auto_number`)
在模板指定列自动生成序号。
```json
"auto_number": {
  "enabled": true,
  "column_name": "A",    // 写入序号的列（列名或字母索引）
  "start_from": 1        // 起始编号
}
```

#### 银行名称映射 (`bank_branch_mapping`)
将输入文件的“开户银行”列的值复制到模板的指定列（通常用于“开户支行”列）。
```json
"bank_branch_mapping": {
  "enabled": true,
  "source_column": "开户银行",
  "target_column": "开户支行"
}
```

#### 月份类型映射 (`month_type_mapping`)
根据运行程序时传入的月份参数，自动生成用途或摘要信息。
```json
"month_type_mapping": {
  "enabled": true,
  "target_column": "用途",
  "month_format": "{month}月工资", // {month} 会被替换为输入的月份
  "bonus_value": "年终奖",         // 当输入为"年终奖"时的值
  "compensation_value": "补偿金"   // 当输入为"补偿金"时的值
}
```

### 3.5 数据验证规则 (`validation_rules`)

在处理前对输入数据进行校验。

```json
"validation_rules": {
  // 必填字段列表
  "required_fields": ["姓名", "卡号", "金额"],
  
  // 数据类型校验
  "data_types": {
    "金额": "numeric",  // 数值
    "日期": "date"      // 日期
  },
  
  // 数值范围校验
  "value_ranges": {
    "金额": {
      "min": 0.01,
      "max": 500000
    }
  }
}
```

## 4. 完整配置示例

请参考项目根目录下的 `config.example.json` 文件，其中包含了一个完整的、包含多规则组（默认组和跨行组）的配置示例。
