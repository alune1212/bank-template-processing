# 配置文件说明 (config.json)

本文档详细说明配置文件中每个字段的含义。

---

## 顶层配置

### version

```json
"version": "1.0"
```

**含义**：配置文件版本号，用于版本兼容性管理。

---

## organization_units

组织单位配置字典，每个键代表一个单位名称，值为该单位的配置。

---

## 单位级别配置

以下字段属于每个单位（如"南京硕博睿达企业管理有限公司"）：

---

### template_path

```json
"template_path": "templates/农业银行模板.csv"
```

**含义**：Excel 模板文件的路径（相对或绝对路径），系统会读取此文件作为数据写入的基础模板。

---

### header_row

```json
"header_row": 0
```

**含义**：模板文件中表头所在的行号（从 0 开始）。
- 值为 0 表示第 1 行
- 值为 4 表示第 5 行
- **值为 0 时表示模板没有表头**，需要使用列标识符（A, B, C...）进行字段映射

---

### start_row

```json
"start_row": 1
```

**含义**：数据开始写入的行号（从 0 开始），必须大于 `header_row`。
- 如果未指定，默认值为 `header_row + 1`
- 用于保留模板的标题、说明等非数据行

---

### row_filter

```json
"row_filter": {
  "exclude_keywords": ["合计", "总计", "小计"]
}
```

**含义**：行过滤配置，用于自动过滤掉输入 Excel 中的特定行（如汇总行、标题行等）。

**工作原理**：
1. 读取每行数据后，检查该行的所有字段值
2. 如果任何字段值包含排除关键字（如"合计"、"总计"），则跳过该行
3. 支持多个排除关键字，灵活配置

**配置说明**：

| 字段名 |           类型 | 必填 | 说明 | 示例 |
|--------------------|------|------|------|------|
| `exclude_keywords` | array | ❌ | 需要排除的关键字列表，如果行的任何字段值包含这些关键字，则跳过该行 | `["合计", "总计", "小计"]` |

**使用场景**：
- 过滤掉 Excel 中的汇总行（如"合计"、"总计"）
- 过滤掉不需要处理的特殊行
- 保持数据行的清洁，避免后续处理错误

**示例**：
```json
"row_filter": {
  "exclude_keywords": ["合计", "总计", "小计", "总计：", "小计："]
}
```

**注意事项**：
- 匹配是部分匹配（包含），不是精确匹配
- 检查所有字段值，只要任何一个包含排除关键字就会跳过该行
- 关键字区分大小写（"合计"和"合计"是不同的）
- 过滤在数据读取阶段进行，不会影响已读取的数据
- 如果没有配置此字段或 `exclude_keywords` 为空，则不过滤任何行

---

## field_mappings（字段映射）

**最重要的配置项**，定义如何从输入 Excel 文件读取数据并写入模板。

### 配置结构

```json
"field_mappings": {
  "字段标识": {
    "source_column": "输入列名或列索引",
    "target_column": "模板列标识",
    "transform": "转换方式",
    "required": true
  }
}
```

### 字典的键（字段标识）

**含义**：只是一个配置标识符，用于组织管理。
- 建议使用有语义的名称，如 `"姓名字段"`、`"卡号字段"`
- 也可以直接使用 `source_column` 的值作为键

### source_column（源列）

**含义**：指定从**输入 Excel 文件**（待处理文件）的哪一列读取数据。

**支持格式**：
1. **列名**（推荐）：
   ```json
   "source_column": "姓名"
   ```
   输入 Excel 有表头时，自动匹配对应的列。

2. **列索引**（0-based）：
   ```json
   "source_column": 0
   ```
   `0` 表示第 1 列，`1` 表示第 2 列。

### target_column（目标列）

**含义**：指定数据写入到**模板文件**（templates 目录下）的哪一列。

**支持格式**（系统自动识别）：

1. **列名**：
   ```json
   "target_column": "姓名"
   ```
   在模板的 `header_row` 行查找对应列名。

2. **Excel 列标识**（推荐用于无表头模板）：
   ```json
   "target_column": "A"
   ```
   `A` = 第 1 列，`B` = 第 2 列，`C` = 第 3 列...

3. **数字索引**（1-based）：
   ```json
   "target_column": 1
   ```
   `1` = 第 1 列，`2` = 第 2 列。

4. **数字字符串**：
   ```json
   "target_column": "1"
   ```

**不指定时**：使用字典的键作为 `target_column`。

### transform（转换方式）

**含义**：指定数据转换方式。

**可选值**：

| 值 | 说明 | 适用场景 |
|-----|------|----------|
| `"none"` | 不进行任何转换，直接复制原值 | 姓名、文本等不需要转换的字段 |
| `"date_format"` | 日期格式转换，统一转换为 `YYYY-MM-DD` 格式 | 日期字段 |
| `"amount_decimal"` | 金额舍入转换，保留指定位数小数 | 金额字段 |
| `"card_number"` | 卡号格式化，移除分隔符并执行 Luhn 校验 | 银行卡号 |

### required（必填）

**含义**：该字段是否为必填项。
- `true`：数据中必须有此字段，否则验证失败
- `false`：字段可选

### field_mappings 完整示例

```json
"field_mappings": {
  "姓名": {
    "source_column": "姓名",
    "target_column": "C",
    "transform": "none",
    "required": true
  },
  "工资卡卡号": {
    "source_column": "工资卡卡号",
    "target_column": "B",
    "transform": "card_number",
    "required": true
  },
  "实发工资": {
    "source_column": "实发工资",
    "target_column": "D",
    "transform": "amount_decimal",
    "required": true
  }
}
```

---

## fixed_values（固定值）

**含义**：为所有数据行的某些列填写固定值，不从输入 Excel 读取。

### 配置结构

```json
"fixed_values": {
  "列标识": "固定值"
}
```

### 列标识支持格式

与 `target_column` 相同，支持：
1. **Excel 列标识**：`"A"`, `"B"`, `"C"`
2. **数字索引**：`1`, `2`, `3`

### 示例

```json
"fixed_values": {
  "E": "浙江省",
  "F": "工资代发"
}
```

**含义**：
- 每行数据的 E 列（第 6 列）都填写"浙江省"
- 每行数据的 F 列（第 7 列）都填写"工资代发"

---

## auto_number（自动编号）

**含义**：自动为每行数据生成序号。

### 配置结构

```json
"auto_number": {
  "enabled": true,
  "column": "A",
  "start_from": 1
}
```

### enabled（启用）

**含义**：是否启用自动编号功能。
- `true`：启用
- `false`：禁用

### column（列标识）

**含义**：序号写入到模板的哪一列。

**支持格式**：
1. **Excel 列标识**：`"A"`, `"B"`, `"C"`（推荐）
2. **数字索引**：`1`, `2`, `3`

### start_from（起始值）

**含义**：序号的起始值。
- 第一行数据填写此值
- 后续行依次递增

### 示例

```json
"auto_number": {
  "enabled": true,
  "column": "A",
  "start_from": 1
}
```

**效果**：
- 第 1 行：序号 = 1
- 第 2 行：序号 = 2
- 第 3 行：序号 = 3

---

## bank_branch_mapping（银行支行映射）

**含义**：将输入 Excel 的"开户银行"列值映射到模板的"开户支行"列。

### 配置结构

```json
"bank_branch_mapping": {
  "enabled": true,
  "source_column": "开户银行",
  "target_column": "G"
}
```

### enabled（启用）

**含义**：是否启用银行支行映射。

### source_column（源列）

**含义**：从输入 Excel 读取银行信息的列名。

### target_column（目标列）

**含义**：银行信息写入到模板的哪一列。

**支持格式**：Excel 列标识（`"A"`, `"B"`, `"C"`）或数字索引

### 示例

```json
"bank_branch_mapping": {
  "enabled": true,
  "source_column": "开户银行",
  "target_column": "G"
}
```

**效果**：
- 输入 Excel 有"开户银行"列，值为"中国农业银行杭州分行"
- 模板的 G 列会填写"中国农业银行杭州分行"

---

## month_type_mapping（月份类型映射）

**含义**：根据命令行传入的月份参数，自动填写收入类型。

### 配置结构

```json
"month_type_mapping": {
  "enabled": true,
  "target_column": "E",
  "month_format": "{month}月收入",
  "bonus_value": "年终奖",
  "compensation_value": "补偿金"
}
```

### enabled（启用）

**含义**：是否启用月份类型映射。

### target_column（目标列）

**含义**：收入类型写入到模板的哪一列。

**支持格式**：Excel 列标识或数字索引

### month_format（月份格式）

**含义**：月份数据的格式模板，`{month}` 会被替换为实际值。

**示例**：
```json
"month_format": "{month}月收入"
```

命令行输入 `01` → 输出 `"01月收入"`
命令行输入 `12` → 输出 `"12月收入"`

### bonus_value（年终奖值）

**含义**：当月份参数为"年终奖"时填写的值。

### compensation_value（补偿金值）

**含义**：当月份参数为"补偿金"时填写的值。

### 月份参数对应关系

| 命令行输入 | 填写值 | 说明 |
|------------|--------|------|
| `"01"` ~ `"12"` | 使用 `month_format` 格式 | 如 `"01月收入"` |
| `"1"` ~ `"9"` | 使用 `month_format` 格式 | 如 `"1月收入"` |
| `"年终奖"` | 使用 `bonus_value` | 如 `"年终奖"` |
| `"补偿金"` | 使用 `compensation_value` | 如 `"补偿金"` |

### 示例

```json
"month_type_mapping": {
  "enabled": true,
  "target_column": "E",
  "month_format": "{month}月收入",
  "bonus_value": "年终奖",
  "compensation_value": "补偿金"
}
```

命令行：
```bash
python main.py input.xlsx 单位名称 01     # 输出："01月收入"
python main.py input.xlsx 单位名称 年终奖   # 输出："年终奖"
python main.py input.xlsx 单位名称 补偿金   # 输出："补偿金"
```

---

## template_selector（动态模板选择）

**含义**：根据输入 Excel 的"开户银行"字段值，自动选择不同的模板文件写入数据。

### 配置结构

```json
"template_selector": {
  "enabled": true,
  "default_bank": "中国农业银行",
  "special_template": "templates/特殊模板.xlsx",
  "bank_column": "开户银行"
}
```

### enabled（启用）

**含义**：是否启用动态模板选择功能。
- `true`：启用，根据"开户银行"字段分组数据并使用不同模板
- `false`：禁用，只使用 `template_path` 指定的模板

### default_bank（默认银行）

**含义**：默认银行的名称，用于判断数据应该使用哪个模板。

### special_template（特殊模板）

**含义**：特殊模板文件的路径（相对或绝对路径），用于非默认银行的数据。

### bank_column（银行列）

**含义**：输入 Excel 中银行信息所在的列名，用于读取银行的名称。

### 工作原理

1. **读取银行列**：从输入 Excel 的 `bank_column` 列读取银行名称
2. **分组数据**：
   - 如果"开户银行" == `default_bank` → 放入默认组
   - 如果"开户银行" != `default_bank` → 放入特殊组
3. **选择模板**：
   - 默认组使用 `template_path` 指定的模板
   - 特殊组使用 `special_template` 指定的模板
4. **生成输出文件**：
   - 每个组生成一个独立的输出文件
   - 文件名包含模板名称标识

### 使用场景

**场景1：数据全部来自默认银行**

输入 Excel：
| 姓名 | 卡号 | 开户银行 | 金额 |
|------|------|----------|------|
| 张三 | 6222... | 中国农业银行 | 5000.00 |
| 李四 | 6225... | 中国农业银行 | 6000.00 |

处理结果：
- 生成 1 个输出文件
- 使用默认模板
- 文件名：`单位名称_默认模板_月份_时间戳.xlsx`

**场景2：数据来自多个银行**

输入 Excel：
| 姓名 | 卡号 | 开户银行 | 金额 |
|------|------|----------|------|
| 张三 | 6222... | 中国农业银行 | 5000.00 |
| 李四 | 6225... | 中国工商银行 | 6000.00 |
| 王五 | 6228... | 中国建设银行 | 7000.00 |

处理结果：
- 生成 2 个输出文件
- 文件1：`单位名称_默认模板_月份_时间戳.xlsx`（包含中国农业银行的数据）
- 文件2：`单位名称_特殊模板_月份_时间戳.xlsx`（包含中国工商银行和中国建设银行的数据）

### 示例

```json
"template_selector": {
  "enabled": true,
  "default_bank": "中国农业银行",
  "special_template": "templates/特殊模板.xlsx",
  "bank_column": "开户银行"
}
```

### 注意事项

1. **bank_column 必须存在**
   - 输入 Excel 必须包含 `bank_column` 指定的列
   - 列值不能为空或 null

2. **模板文件必须存在**
   - `template_path` 指定的默认模板必须存在
   - `special_template` 指定的特殊模板必须存在

3. **输出文件命名**
   - 单模板模式：`{unit_name}_{month}_{timestamp}.xlsx`
   - 动态模板模式：`{unit_name}_{template_name}_{month}_{timestamp}.xlsx`

4. **空组处理**
   - 如果某个分组没有数据，会跳过该组的输出
   - 日志中会记录"跳过空组"的警告信息

---

## transformations（数据转换参数）

**含义**：定义各种数据转换方式的具体参数。

### 配置结构

```json
"transformations": {
  "date": {
    "output_format": "YYYY-MM-DD"
  },
  "amount": {
    "decimal_places": 2,
    "rounding": "round"
  },
  "card_number": {
    "remove_formatting": true,
    "luhn_validation": true
  }
}
```

### date（日期转换）

| 字段 | 含义 |
|------|------|
| `output_format` | 输出日期格式，目前仅支持 `"YYYY-MM-DD"` |

**支持的输入日期格式**：
- `YYYY-MM-DD`（如：2024-01-15）
- `DD/MM/YYYY`（如：15/01/2024）
- `MM/DD/YYYY`（如：01/15/2024）
- `YYYY年MM月DD日`（如：2024年01月15日）
- `YYYY-M-D`（如：2024-1-15）

### amount（金额转换）

| 字段 | 含义 |
|------|------|
| `decimal_places` | 保留小数位数，默认为 2 |
| `rounding` | 舍入方式，目前仅支持 `"round"`（四舍五入） |

**转换示例**：
| 输入值 | `decimal_places: 2` | `decimal_places: 4` |
|----------|-------------------|-------------------|
| `123.456789` | `123.46` | `123.4568` |
| `100.5` | `100.50` | `100.5000` |

### card_number（卡号转换）

| 字段 | 含义 |
|------|------|
| `remove_formatting` | 是否移除格式字符（空格、横杠等） |
| `luhn_validation` | 是否执行 Luhn 校验确保卡号有效性 |

**Luhn 算法**：
- 从右向左遍历
- 偶数位（从右数）乘以 2
- 如果乘积大于 9，则减去 9
- 所有数字相加
- 总和能被 10 整除则有效

### 示例

```json
"transformations": {
  "card_number": {
    "remove_formatting": true,
    "luhn_validation": true
  }
}
```

处理：
- `6222 1234 5678 9012` → `62221234567890122`（移除空格）
- 验证 Luhn 算法

---

## validation_rules（数据验证规则）

**含义**：定义数据验证规则，确保输入数据的正确性。

### 配置结构

```json
"validation_rules": {
  "required_fields": ["姓名", "卡号", "金额", "日期"],
  "data_types": {
    "金额": "numeric",
    "日期": "date"
  }
}
```

### required_fields（必填字段）

**含义**：列出所有必填的字段名称（source_column 的值）。

**规则**：
- 字段为空或不存在 → 验证失败
- 所有必填字段都存在 → 验证通过

### data_types（数据类型）

**含义**：验证字段的数据类型。

**支持的数据类型**：

| 类型名 | 说明 |
|--------|------|
| `"numeric"` | 数值类型（可解析为 int 或 float） |
| `"integer"` | 整数类型 |
| `"float"` | 浮点数类型 |
| `"string"` | 字符串类型 |
| `"boolean"` | 布尔值（`true` 或 `false`） |
| `"date"` | 日期类型（可被日期转换器解析） |

### 示例

```json
"validation_rules": {
  "required_fields": ["姓名", "卡号", "金额", "日期"],
  "data_types": {
    "金额": "numeric",
    "日期": "date"
  }
}
```

**验证效果**：
- `金额` 必须是数值（如 `5000.00`）→ 通过
- `金额` 是文本（如 `"五千"`）→ 失败
- `日期` 必须是可解析的日期格式 → 通过

"target_column" 配置的优先级：
1. 如果明确指定了 `target_column`，使用该值
2. 如果未指定，使用字典的键

### source_column 的使用

1. **列名**：
   ```json
   "source_column": "姓名"
   ```
   适用于输入 Excel 有表头的情况

2. **列索引（0-based）**：
   ```json
   "source_column": 0
   ```
   `0` = 第 1 列，`1` = 第 2 列

### target_column 的使用（智能解析）

1. **列名**：
   ```json
   "target_column": "姓名"
   ```
   在模板的 `header_row` 行查找

2. **Excel 列标识**（推荐用于无表头模板）：
   ```json
   "target_column": "A"
   ```
   `A` = 第 1 列，`B` = 第 2 列

3. **数字索引（1-based）**：
   ```json
   "target_column": 1
   ```
   `1` = 第 1 列，`2` = 第 2 列

---

## 完整配置示例

```json
{
  "version": "1.0",
  "organization_units": {
    "南京硕博睿达企业管理有限公司": {
      "template_path": "templates/农业银行模板.csv",
      "header_row": 0,
      "start_row": 1,
      "field_mappings": {
        "姓名": {
          "source_column": "姓名",
          "target_column": "C",
          "transform": "none",
          "required": true
        },
        "工资卡卡号": {
          "source_column": "工资卡卡号",
          "target_column": "B",
          "transform": "card_number",
          "required": true
        },
        "实发工资": {
          "source_column": "实发工资",
          "target_column": "D",
          "transform": "amount_decimal",
          "required": true
        }
      },
      "auto_number": {
        "enabled": true,
        "column": "A",
        "start_from": 1
      },
      "bank_branch_mapping": {
        "enabled": false,
        "source_column": "",
        "target_column": ""
      },
      "month_type_mapping": {
        "enabled": true,
        "target_column": "E",
        "month_format": "{month}月收入",
        "bonus_value": "年终奖",
        "compensation_value": "补偿金"
      },
      "transformations": {
        "date": {
          "output_format": "YYYY-MM-DD"
        },
        "amount": {
          "decimal_places": 2,
          "rounding": "round"
        },
        "card_number": {
          "remove_formatting": true,
          "luhn_validation": true
        }
      },
      "validation_rules": {
        "data_types": {
          "实发工资": "numeric",
          "工资卡卡号": "integer"
        }
      }
    }
  }
}
```

---

## 使用最佳实践

1. **使用 Excel 列标识作为 target_column**
   - 模板没有表头时最可靠
   - 清晰明确，不容易出错
   - 示例：`"A"`, `"B"`, `"C"`

2. **明确指定 target_column**
   - 不依赖字典键的默认值
   - 配置更清晰可读

3. **使用语义化的字典键**
   - 便于理解和维护
   - 示例：`"姓名字段"` 而不是 `"name"`

4. **合理的 header_row 和 start_row**
   - `start_row` 必须 > `header_row`
   - 保留模板的标题、说明等非数据行
